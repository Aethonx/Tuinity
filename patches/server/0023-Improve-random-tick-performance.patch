From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Wed, 27 Nov 2019 04:54:58 -0800
Subject: [PATCH] Improve random tick performance


diff --git a/src/main/java/ca/spottedleaf/tuinity/util/ThreadUnsafeRandom.java b/src/main/java/ca/spottedleaf/tuinity/util/ThreadUnsafeRandom.java
new file mode 100644
index 0000000000000000000000000000000000000000..084e3408d8edd7b8cee1e8f27f5f798d37238fbf
--- /dev/null
+++ b/src/main/java/ca/spottedleaf/tuinity/util/ThreadUnsafeRandom.java
@@ -0,0 +1,36 @@
+package ca.spottedleaf.tuinity.util;
+
+import java.util.Random;
+
+public final class ThreadUnsafeRandom extends Random {
+
+    // See javadoc and internal comments for java.util.Random where these values come from, how they are used, and the author for them.
+    private static final long multiplier = 0x5DEECE66DL;
+    private static final long addend = 0xBL;
+    private static final long mask = (1L << 48) - 1;
+
+    private static long initialScramble(long seed) {
+        return (seed ^ multiplier) & mask;
+    }
+
+    private long seed;
+
+    @Override
+    public void setSeed(long seed) {
+        // note: called by Random constructor
+        this.seed = initialScramble(seed);
+    }
+
+    @Override
+    protected int next(int bits) {
+        // avoid the expensive CAS logic used by superclass
+        return (int) (((this.seed = this.seed * multiplier + addend) & mask) >>> (48 - bits));
+    }
+
+    @Override
+    public int nextInt(int bound) {
+        // yes this breaks random's spec
+        // however there's nothing that uses this class that relies on it
+        return ca.spottedleaf.tuinity.util.Util.fastRandomBounded(this.next(32) & 0xFFFFFFFFL, bound);
+    }
+}
diff --git a/src/main/java/net/minecraft/server/BiomeBase.java b/src/main/java/net/minecraft/server/BiomeBase.java
index 0102a170dc333fb4af01efa0aaa66df85271f1e0..b7b2326c4885bccd1e4a85d16f89933af32ffa09 100644
--- a/src/main/java/net/minecraft/server/BiomeBase.java
+++ b/src/main/java/net/minecraft/server/BiomeBase.java
@@ -166,12 +166,18 @@ public abstract class BiomeBase {
     }
 
     public boolean a(IWorldReader iworldreader, BlockPosition blockposition, boolean flag) {
+        // Tuinity start - Add Chunk parameter
+        return this.transformWater(iworldreader, blockposition, flag, null);
+    }
+    public boolean transformWater(IWorldReader iworldreader, BlockPosition blockposition, boolean flag, IChunkAccess chunk) {
+        // Tuinity end - Add Chunk parameter
         if (this.getAdjustedTemperature(blockposition) >= 0.15F) {
             return false;
         } else {
             if (blockposition.getY() >= 0 && blockposition.getY() < 256 && iworldreader.getBrightness(EnumSkyBlock.BLOCK, blockposition) < 10) {
-                IBlockData iblockdata = iworldreader.getType(blockposition);
-                Fluid fluid = iworldreader.getFluid(blockposition);
+                if (chunk == null) chunk = iworldreader.getChunkAt(blockposition.getX() >> 4, blockposition.getZ() >> 4); // Tuinity - Add Chunk parameter
+                IBlockData iblockdata = chunk.getType(blockposition); // Tuinity - avoid chunk lookup
+                Fluid fluid = iblockdata.getFluid(); // Tuinity - avoid chunk lookup + IBlockData lookup
 
                 if (fluid.getType() == FluidTypes.WATER && iblockdata.getBlock() instanceof BlockFluids) {
                     if (!flag) {
@@ -191,11 +197,17 @@ public abstract class BiomeBase {
     }
 
     public boolean b(IWorldReader iworldreader, BlockPosition blockposition) {
+        // Tuinity start - add Chunk parameter
+        return this.canPlaceSnow(iworldreader, blockposition, null);
+    }
+    public boolean canPlaceSnow(IWorldReader iworldreader, BlockPosition blockposition, IChunkAccess chunk) {
+        // Tuinity end - add Chunk parameter
         if (this.getAdjustedTemperature(blockposition) >= 0.15F) {
             return false;
         } else {
             if (blockposition.getY() >= 0 && blockposition.getY() < 256 && iworldreader.getBrightness(EnumSkyBlock.BLOCK, blockposition) < 10) {
-                IBlockData iblockdata = iworldreader.getType(blockposition);
+                if (chunk == null) chunk = iworldreader.getChunkAt(blockposition.getX() >> 4, blockposition.getZ() >> 4); // Tuinity - Add Chunk parameter
+                IBlockData iblockdata = chunk.getType(blockposition); // Tuinity - avoid chunk lookup
 
                 if (iblockdata.isAir() && Blocks.SNOW.getBlockData().canPlace(iworldreader, blockposition)) {
                     return true;
diff --git a/src/main/java/net/minecraft/server/BlockFluids.java b/src/main/java/net/minecraft/server/BlockFluids.java
index 6d351f0979ecfa8e500edf8dd03b4a455fd5d180..2541eaae94ec14f09cafb0d2cde0dab58e2f6a03 100644
--- a/src/main/java/net/minecraft/server/BlockFluids.java
+++ b/src/main/java/net/minecraft/server/BlockFluids.java
@@ -27,7 +27,7 @@ public class BlockFluids extends Block implements IFluidSource {
 
     @Override
     public void b(IBlockData iblockdata, WorldServer worldserver, BlockPosition blockposition, Random random) {
-        worldserver.getFluid(blockposition).b(worldserver, blockposition, random);
+        iblockdata.getFluid().b(worldserver, blockposition, random); // Tuinity - avoid another getType call
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/server/Chunk.java b/src/main/java/net/minecraft/server/Chunk.java
index 0b2a8a5258cab2e57f054ca4c5ba98314885488a..7405c936cdfcec6ff31c0e9393d487d10363ec52 100644
--- a/src/main/java/net/minecraft/server/Chunk.java
+++ b/src/main/java/net/minecraft/server/Chunk.java
@@ -90,6 +90,8 @@ public class Chunk implements IChunkAccess {
     private final int[] inventoryEntityCounts = new int[16];
     // Paper end
 
+    final ca.spottedleaf.tuinity.util.IBlockDataList tickingList = new ca.spottedleaf.tuinity.util.IBlockDataList(); // Tuinity
+
     public Chunk(World world, ChunkCoordIntPair chunkcoordintpair, BiomeStorage biomestorage, ChunkConverter chunkconverter, TickList<Block> ticklist, TickList<FluidType> ticklist1, long i, @Nullable ChunkSection[] achunksection, @Nullable Consumer<Chunk> consumer) {
         this.sections = new ChunkSection[16];
         this.e = Maps.newHashMap();
@@ -124,6 +126,18 @@ public class Chunk implements IChunkAccess {
         this.v = consumer;
         if (achunksection != null) {
             if (this.sections.length == achunksection.length) {
+                // Tuinity start
+                for (ChunkSection section : achunksection) {
+                    if (section != null) {
+                        section.chunk = this;
+                        int offset = ca.spottedleaf.tuinity.util.IBlockDataList.getLocationKey(0, section.yPos, 0);
+                        for (it.unimi.dsi.fastutil.longs.LongIterator iterator = section.tickingList.getRawIterator(); iterator.hasNext();) {
+                            long raw = iterator.nextLong();
+                            this.tickingList.add(ca.spottedleaf.tuinity.util.IBlockDataList.getLocationFromRaw(raw) + offset, ca.spottedleaf.tuinity.util.IBlockDataList.getBlockDataFromRaw(raw));
+                        }
+                    }
+                }
+                // Tuinity start
                 System.arraycopy(achunksection, 0, this.sections, 0, this.sections.length);
             } else {
                 Chunk.LOGGER.warn("Could not set level chunk sections, array length is {} instead of {}", achunksection.length, this.sections.length);
diff --git a/src/main/java/net/minecraft/server/ChunkSection.java b/src/main/java/net/minecraft/server/ChunkSection.java
index 4526527aca19bf9c57d7e77a661c847131867d5a..bb3597233b1f36717885e0437fcb9aef820e9d6d 100644
--- a/src/main/java/net/minecraft/server/ChunkSection.java
+++ b/src/main/java/net/minecraft/server/ChunkSection.java
@@ -5,11 +5,13 @@ import javax.annotation.Nullable;
 public class ChunkSection {
 
     public static final DataPalette<IBlockData> GLOBAL_PALETTE = new DataPaletteGlobal<>(Block.REGISTRY_ID, Blocks.AIR.getBlockData());
-    private final int yPos;
+    final int yPos; // Tuinity - private -> package
     short nonEmptyBlockCount; // Paper - private -> package-private
-    private short tickingBlockCount;
+    short tickingBlockCount; // Tuinity - private -> package
     private short e;
     final DataPaletteBlock<IBlockData> blockIds;
+    Chunk chunk; // Tuinity
+    final ca.spottedleaf.tuinity.util.IBlockDataList tickingList = new ca.spottedleaf.tuinity.util.IBlockDataList(); // Tuinity
 
     public ChunkSection(int i) {
         // Paper start - add parameters
@@ -31,6 +33,11 @@ public class ChunkSection {
         this.tickingBlockCount = short1;
         this.e = short2;
         this.blockIds = new DataPaletteBlock<>(ChunkSection.GLOBAL_PALETTE, Block.REGISTRY_ID, GameProfileSerializer::d, GameProfileSerializer::a, Blocks.AIR.getBlockData(), world instanceof GeneratorAccess ? ((GeneratorAccess) world).getMinecraftWorld().chunkPacketBlockController.getPredefinedBlockData(world, chunk, this, initializeBlocks) : null, initializeBlocks); // Paper - Anti-Xray - Add predefined block data
+        // Tuinity start
+        if (chunk instanceof Chunk) {
+            this.chunk = (Chunk)chunk;
+        }
+        // Tuinity end
     }
 
     public IBlockData getType(int i, int j, int k) {
@@ -69,6 +76,12 @@ public class ChunkSection {
             --this.nonEmptyBlockCount;
             if (iblockdata1.q()) {
                 --this.tickingBlockCount;
+                // Tuinity start
+                this.tickingList.remove(i, j, k);
+                if (this.chunk != null) {
+                    this.chunk.tickingList.remove(i, j + this.yPos, k);
+                }
+                // Tuinity end
             }
         }
 
@@ -80,6 +93,12 @@ public class ChunkSection {
             ++this.nonEmptyBlockCount;
             if (iblockdata.q()) {
                 ++this.tickingBlockCount;
+                // Tuinity start
+                this.tickingList.add(i, j, k, iblockdata);
+                if (this.chunk != null) {
+                    this.chunk.tickingList.add(i, j + this.yPos, k, iblockdata);
+                }
+                // Tuinity end
             }
         }
 
@@ -115,23 +134,39 @@ public class ChunkSection {
     }
 
     public void recalcBlockCounts() {
+        // Tuinity start
+        int offset = ca.spottedleaf.tuinity.util.IBlockDataList.getLocationKey(0, this.yPos, 0);
+        if (this.chunk != null) {
+            for (it.unimi.dsi.fastutil.longs.LongIterator iterator = this.tickingList.getRawIterator(); iterator.hasNext();) {
+                long raw = iterator.nextLong();
+                this.chunk.tickingList.remove(ca.spottedleaf.tuinity.util.IBlockDataList.getLocationFromRaw(raw) + offset);
+            }
+        }
+        this.tickingList.clear();
+        // Tuinity end
         this.nonEmptyBlockCount = 0;
         this.tickingBlockCount = 0;
         this.e = 0;
-        this.blockIds.a((iblockdata, i) -> {
+        this.blockIds.forEachLocation((iblockdata, location) -> { // Tuinity
             Fluid fluid = iblockdata.getFluid();
 
             if (!iblockdata.isAir()) {
-                this.nonEmptyBlockCount = (short) (this.nonEmptyBlockCount + i);
+                this.nonEmptyBlockCount = (short) (this.nonEmptyBlockCount + 1); // Tuinity
                 if (iblockdata.q()) {
-                    this.tickingBlockCount = (short) (this.tickingBlockCount + i);
+                    // Tuinity start
+                    this.tickingList.add(location, iblockdata);
+                    if (this.chunk != null) {
+                        this.chunk.tickingList.add(location + offset, iblockdata);
+                    }
+                    this.tickingBlockCount = (short) (this.tickingBlockCount + 1);
+                    // Tuinity end
                 }
             }
 
             if (!fluid.isEmpty()) {
-                this.nonEmptyBlockCount = (short) (this.nonEmptyBlockCount + i);
+                this.nonEmptyBlockCount = (short) (this.nonEmptyBlockCount + 1); // Tuinity
                 if (fluid.h()) {
-                    this.e = (short) (this.e + i);
+                    this.e = (short) (this.e + 1); // Tuinity
                 }
             }
 
diff --git a/src/main/java/net/minecraft/server/DataBits.java b/src/main/java/net/minecraft/server/DataBits.java
index f9680b6830c77f31e1eb8b6845dd6d58d04f624a..4144788883325c538c0bee64a585a8371ab83889 100644
--- a/src/main/java/net/minecraft/server/DataBits.java
+++ b/src/main/java/net/minecraft/server/DataBits.java
@@ -127,4 +127,46 @@ public class DataBits {
 
         }
     }
+
+    // Tuinity start
+    public void forEach(DataBitConsumer consumer) {
+        // Note: copied from above
+        int i = this.a.length;
+
+        if (i != 0) {
+            int j = 0;
+            long k = this.a[0];
+            long l = i > 1 ? this.a[1] : 0L;
+
+            for (int i1 = 0; i1 < this.d; ++i1) {
+                int j1 = i1 * this.b;
+                int k1 = j1 >> 6;
+                int l1 = (i1 + 1) * this.b - 1 >> 6;
+                int i2 = j1 ^ k1 << 6;
+
+                if (k1 != j) {
+                    k = l;
+                    l = k1 + 1 < i ? this.a[k1 + 1] : 0L;
+                    j = k1;
+                }
+
+                if (k1 == l1) {
+                    consumer.accept(i1, (int) (k >>> i2 & this.c));
+                } else {
+                    int j2 = 64 - i2;
+
+                    consumer.accept(i1, (int) ((k >>> i2 | l << j2) & this.c));
+                }
+            }
+
+        }
+    }
+
+    @FunctionalInterface
+    static interface DataBitConsumer {
+
+        void accept(int location, int data);
+
+    }
+    // Tuinity end
 }
diff --git a/src/main/java/net/minecraft/server/DataPaletteBlock.java b/src/main/java/net/minecraft/server/DataPaletteBlock.java
index 44aed67274b1a10726ad91b261b159289f36b6d9..1d94dbae8738db14b81c6a1f05537885f88b051d 100644
--- a/src/main/java/net/minecraft/server/DataPaletteBlock.java
+++ b/src/main/java/net/minecraft/server/DataPaletteBlock.java
@@ -287,6 +287,14 @@ public class DataPaletteBlock<T> implements DataPaletteExpandable<T> {
         });
     }
 
+    // Tuinity start
+    public void forEachLocation(DataPaletteBlock.a<T> datapaletteblock_a) {
+        this.getDataBits().forEach((int location, int data) -> {
+            datapaletteblock_a.accept(this.getDataPalette().getObject(data), location);
+        });
+    }
+    // Tuinity end
+
     @FunctionalInterface
     public interface a<T> {
 
diff --git a/src/main/java/net/minecraft/server/FluidImpl.java b/src/main/java/net/minecraft/server/FluidImpl.java
index ac9b8909135074ccdc8b9d2886b1b74939853231..b326e592ed28a1e1300622486de5941784c27d7d 100644
--- a/src/main/java/net/minecraft/server/FluidImpl.java
+++ b/src/main/java/net/minecraft/server/FluidImpl.java
@@ -6,10 +6,19 @@ public class FluidImpl extends BlockDataAbstract<FluidType, Fluid> implements Fl
 
     public FluidImpl(FluidType fluidtype, ImmutableMap<IBlockState<?>, Comparable<?>> immutablemap) {
         super(fluidtype, immutablemap);
+        this.isLava = this.getType().j(); // Tuinity
     }
 
     @Override
     public FluidType getType() {
         return (FluidType) this.a;
     }
+
+    // Tuinity start
+    private final boolean isLava;
+
+    public final boolean h() {
+        return this.isLava;
+    }
+    // Tuinity end
 }
diff --git a/src/main/java/net/minecraft/server/IBlockData.java b/src/main/java/net/minecraft/server/IBlockData.java
index de43881653ff37e38dc42c7f953dc96126a30c61..05f5cd4a42250a4b988b8b4ece3d86efe3b257a7 100644
--- a/src/main/java/net/minecraft/server/IBlockData.java
+++ b/src/main/java/net/minecraft/server/IBlockData.java
@@ -27,6 +27,7 @@ public class IBlockData extends BlockDataAbstract<Block, IBlockData> implements
         super(block, immutablemap);
         this.d = block.a(this);
         this.e = block.o(this);
+        this.isTicking = this.getBlock().isTicking(this); // Tuinity
     }
 
     public void c() {
@@ -267,12 +268,19 @@ public class IBlockData extends BlockDataAbstract<Block, IBlockData> implements
         return this.getBlock().a(tag);
     }
 
+    private Fluid fluid;
     public Fluid getFluid() {
-        return this.getBlock().a_(this);
+        if (this.fluid != null) {
+            return this.fluid;
+        }
+        return this.fluid = this.getBlock().a_(this);
     }
 
+    // Tuinity start
+    private final boolean isTicking;
     public boolean q() {
-        return this.getBlock().isTicking(this);
+        return this.isTicking;
+        // Tuinity end
     }
 
     public final SoundEffectType getStepSound() { return this.r(); } // Paper - OBFHELPER
diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 9602d1a06d10e2101ed223add8a5a73cce0aa1a9..f8031cde57109c3e01f05534c41dca66b32b1dc4 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -559,6 +559,9 @@ public class WorldServer extends World {
     }
 
     private final BlockPosition.MutableBlockPosition chunkTickMutablePosition = new BlockPosition.MutableBlockPosition(); // Tuinity - use mutable to reduce allocation rate
+    // Tuinity start
+    private final ca.spottedleaf.tuinity.util.ThreadUnsafeRandom randomTickRandom = new ca.spottedleaf.tuinity.util.ThreadUnsafeRandom();
+    // Tuinity end
 
     public void a(Chunk chunk, int i) {
         ChunkCoordIntPair chunkcoordintpair = chunk.getPos();
@@ -570,7 +573,7 @@ public class WorldServer extends World {
         gameprofilerfiller.enter("thunder");
         final BlockPosition.MutableBlockPosition blockposition = this.chunkTickMutablePosition; // Tuinity - use mutable to reduce allocation rate, final to force compile fail on change
 
-        if (!this.paperConfig.disableThunder && flag && this.U() && this.random.nextInt(100000) == 0) { // Paper - Disable thunder
+        if (!this.paperConfig.disableThunder && flag && this.U() && this.randomTickRandom.nextInt(100000) == 0) { // Paper - Disable thunder // Tuinity
             blockposition.setValues(this.a(this.getRandomBlockPosition(j, 0, k, 15, blockposition))); // Tuinity - use mutable to reduce allocation rate
             if (this.isRainingAt(blockposition)) {
                 DifficultyDamageScaler difficultydamagescaler = this.getDamageScaler(blockposition);
@@ -590,61 +593,75 @@ public class WorldServer extends World {
         }
 
         gameprofilerfiller.exitEnter("iceandsnow");
-        if (!this.paperConfig.disableIceAndSnow && this.random.nextInt(16) == 0) { // Paper - Disable ice and snow
-            blockposition.setValues(this.getHighestBlockYAt(HeightMap.Type.MOTION_BLOCKING, this.getRandomBlockPosition(j, 0, k, 15, blockposition))); // Tuinity - use mutable to reduce allocation rate
-            BlockPosition blockposition1 = blockposition.down();
+        // Tuinity start
+        if (!this.paperConfig.disableIceAndSnow && this.randomTickRandom.nextInt(16) == 0) { // Paper - Disable ice and snow
+            this.getRandomBlockPosition(j, 0, k, 15, blockposition);
+            int normalY = chunk.getHighestBlockYAt(HeightMap.Type.MOTION_BLOCKING, blockposition.getX(), blockposition.getZ());
+            int downY = normalY - 1;
+            blockposition.setY(normalY);
             BiomeBase biomebase = this.getBiome(blockposition);
 
-            if (biomebase.a((IWorldReader) this, blockposition1)) {
-                org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockFormEvent(this, blockposition1, Blocks.ICE.getBlockData(), null); // CraftBukkit
+            blockposition.setY(downY);
+            if (biomebase.transformWater((IWorldReader) this, blockposition, true, chunk)) {
+                org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockFormEvent(this, blockposition, Blocks.ICE.getBlockData(), null); // CraftBukkit
             }
 
-            if (flag && biomebase.b(this, blockposition)) {
+            blockposition.setY(normalY);
+            if (flag && biomebase.canPlaceSnow(this, blockposition, chunk)) {
                 org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockFormEvent(this, blockposition, Blocks.SNOW.getBlockData(), null); // CraftBukkit
             }
+            blockposition.setY(blockposition.getY() - 1);
 
-            if (flag && this.getBiome(blockposition1).d() == BiomeBase.Precipitation.RAIN) {
-                this.getType(blockposition1).getBlock().c((World) this, blockposition1);
+            if (flag && this.getBiome(blockposition).d() == BiomeBase.Precipitation.RAIN) {
+                this.getType(blockposition).getBlock().c((World) this, blockposition);
             }
+            // Tuinity end
         }
 
-        gameprofilerfiller.exitEnter("tickBlocks");
-        timings.chunkTicksBlocks.startTiming(); // Paper
-        if (i > 0) {
-            ChunkSection[] achunksection = chunk.getSections();
-            int l = achunksection.length;
-
-            for (int i1 = 0; i1 < l; ++i1) {
-                ChunkSection chunksection = achunksection[i1];
-
-                if (chunksection != Chunk.a && chunksection.d()) {
-                    int j1 = chunksection.getYPosition();
-
-                    for (int k1 = 0; k1 < i; ++k1) {
-                        BlockPosition blockposition2 = this.getRandomBlockPosition(j, j1, k, 15, blockposition); // Tuinity - use mutable to reduce allocation rate
-
-                        gameprofilerfiller.enter("randomTick");
-                        IBlockData iblockdata = chunksection.getType(blockposition2.getX() - j, blockposition2.getY() - j1, blockposition2.getZ() - k);
+        gameprofilerfiller.exit();
+        // Tuinity start - optimise random block tick
+        int blocks = chunk.tickingList.size();
+        if (i > 0 && blocks > 0) { // Tuinity
+            if ((this.randomTickRandom.nextInt() & (16 * 16 * 256 - 1)) > blocks) {
+                // we optimise random block ticking by realising that most of the blocks we will try to tick
+                // are not tickable. Instead we only tick tickable blocks, but only if the above
+                // statement is true
+                // Note: The number of blocks that get ticked per tick still REMAIN the same.
+                return;
+            }
+            gameprofilerfiller.enter("tickBlocks");
+            timings.chunkTicksBlocks.startTiming(); // Paper
 
-                        if (iblockdata.q()) {
-                            iblockdata.getBlock().randomTick = true; // Paper - fix MC-113809
-                            iblockdata.b(this, blockposition2, this.random);
-                            iblockdata.getBlock().randomTick = false; // Paper - fix MC-113809
-                        }
+            int toTick = i << 4; // i * 16
 
-                        Fluid fluid = iblockdata.getFluid();
+            gameprofilerfiller.enter("randomTick");
+            for (int tick = 0; tick < toTick; ++tick) {
+                int tickingSize = chunk.tickingList.size();
+                if (tickingSize == 0) {
+                    break;
+                }
+                int index = this.randomTickRandom.nextInt(tickingSize);
+                long raw = chunk.tickingList.getRaw(index);
+                int location = ca.spottedleaf.tuinity.util.IBlockDataList.getLocationFromRaw(raw);
+                int randomX = location & 15;
+                int randomY = (location >>> (4 + 4)) & 255;
+                int randomZ = (location >>> 4) & 15;
+                BlockPosition blockposition2 = blockposition.setValues(j + randomX, randomY, k + randomZ);
+                IBlockData iblockdata = ca.spottedleaf.tuinity.util.IBlockDataList.getBlockDataFromRaw(raw);
 
-                        if (fluid.h()) {
-                            fluid.b(this, blockposition2, this.random);
-                        }
+                iblockdata.getBlock().randomTick = true; // Paper - fix MC-113809
+                iblockdata.b(this, blockposition2, this.randomTickRandom);
+                iblockdata.getBlock().randomTick = false; // Paper - fix MC-113809
 
-                        gameprofilerfiller.exit();
-                    }
-                }
+                // We drop the fluid tick since LAVA is ALREADY TICKED by the above method.
+                // TODO THIS NEEDS TO BE CHECKED ON UPDATE
             }
+
+            gameprofilerfiller.exit();
+            timings.chunkTicksBlocks.stopTiming(); // Paper
+            gameprofilerfiller.exit();
+            // Tuinity end - optimise random block tick
         }
-        timings.chunkTicksBlocks.stopTiming(); // Paper
-        gameprofilerfiller.exit();
     }
 
     protected BlockPosition a(BlockPosition blockposition) {
