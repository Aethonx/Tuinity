From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Sun, 22 Dec 2019 08:26:31 -0800
Subject: [PATCH] Fix checkDespawn

- Didn't have softDespawn paper config entirely well
- Properly ignore players who do not affect spawning

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index bce502181fa56a0536af2c9084641d98417e56e7..3f025f2dfd2ba775d00af66c294c132887184685 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -108,7 +108,7 @@ public class PaperWorldConfig {
     }
 
     public int softDespawnDistance;
-    public int hardDespawnDistance;
+    public int hardDespawnDistance; public double hardDespawnDistanceNotSquared; /* Concrete */
     private void despawnDistances() {
         softDespawnDistance = getInt("despawn-ranges.soft", 32); // 32^2 = 1024, Minecraft Default
         hardDespawnDistance = getInt("despawn-ranges.hard", 128); // 128^2 = 16384, Minecraft Default
@@ -118,6 +118,7 @@ public class PaperWorldConfig {
         }
 
         log("Living Entity Despawn Ranges:  Soft: " + softDespawnDistance + " Hard: " + hardDespawnDistance);
+        hardDespawnDistanceNotSquared = hardDespawnDistance; /* Concrete */
 
         softDespawnDistance = softDespawnDistance*softDespawnDistance;
         hardDespawnDistance = hardDespawnDistance*hardDespawnDistance;
diff --git a/src/main/java/net/minecraft/server/EntityInsentient.java b/src/main/java/net/minecraft/server/EntityInsentient.java
index e0355d3a300b91756f20f0142e7b6fcb136e2dac..51e876fe29f5780aab561812080cbbe892f2bfdd 100644
--- a/src/main/java/net/minecraft/server/EntityInsentient.java
+++ b/src/main/java/net/minecraft/server/EntityInsentient.java
@@ -633,20 +633,27 @@ public abstract class EntityInsentient extends EntityLiving {
         if (this.world.getDifficulty() == EnumDifficulty.PEACEFUL && this.J()) {
             this.die();
         } else if (!this.isPersistent() && !this.I()) {
-            EntityHuman entityhuman = this.world.findNearbyPlayer(this, -1.0D);
+            EntityHuman entityhuman = this.world.findClosestPlayer(this.locX(), this.locY(), this.locZ(), this.world.paperConfig.hardDespawnDistanceNotSquared, (Entity player) ->  (((EntityHuman)player).affectsSpawning && !((EntityHuman)player).isSpectator())); /* Concrete - fix this function to properly handle spawning api */
 
-            if (entityhuman != null && entityhuman.affectsSpawning) { // Paper - Affects Spawning API
+            if (entityhuman != null) { // Paper - Affects Spawning API /* Concrete - check not needed anymore */
                 double d0 = entityhuman.h(this);
 
                 if (d0 > world.paperConfig.hardDespawnDistance) { // CraftBukkit - remove isTypeNotPersistent() check // Paper - custom despawn distances
                     this.die();
-                }
-
-                if (this.ticksFarFromPlayer > 600 && this.random.nextInt(800) == 0 && d0 > world.paperConfig.softDespawnDistance) { // CraftBukkit - remove isTypeNotPersistent() check // Paper - custom despawn distances
+                } else if (this.ticksFarFromPlayer > 600 && this.random.nextInt(800) == 0 && d0 > world.paperConfig.softDespawnDistance) { // CraftBukkit - remove isTypeNotPersistent() check // Paper - custom despawn distances /* Concrete */
                     this.die();
-                } else if (d0 < 1024.0D) {
+                } else if (d0 < world.paperConfig.softDespawnDistance) { /* Concrete */
                     this.ticksFarFromPlayer = 0;
                 }
+            } else { /* Concrete start */
+                // no player in range, try all players
+                for (EntityHuman player : this.world.getPlayers()) {
+                    if (player.affectsSpawning && !player.isSpectator()) {
+                        this.die();
+                        break;
+                    }
+                }
+                /* Concret eend */
             }
 
         } else {
