From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <spottedleaf@spottedleaf.dev>
Date: Sat, 23 May 2020 11:57:53 -0700
Subject: [PATCH] Make a better attempt at force killing the main thread

Single stop calls can be stopped by bad try catches, that do not
rethrow threaddeath. So try to spam stop for 10s.

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index ecca60403038ca2eef92efef4022bc3e8b5781f9..85cc5914e11356dbc70e1b684627c5e67c83616c 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -730,7 +730,12 @@ public abstract class MinecraftServer extends IAsyncTaskHandlerReentrant<TickTas
             hasStopped = true;
             org.spigotmc.WatchdogThread.doStop(); // Paper
             if (!isMainThread()) {
-                this.getThread().stop();
+                // Tuinity start - make a better attempt at stopping
+                long start = System.nanoTime();
+                do {
+                    this.getThread().stop();
+                } while (this.getThread().isAlive() && (System.nanoTime() - start) > (java.util.concurrent.TimeUnit.SECONDS.toNanos(10)));
+                // Tuinity end - make a better attempt at stopping
             }
         }
         // CraftBukkit end
